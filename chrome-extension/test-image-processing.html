<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像処理機能テスト - AdPreviewCapture</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-element {
            margin: 10px 0;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 5px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            text-align: center;
            font-weight: bold;
        }
        .complex-element {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="50" height="50" fill="red"/><rect x="50" y="50" width="50" height="50" fill="blue"/><circle cx="50" cy="50" r="25" fill="yellow"/></svg>') repeat;
            color: black;
        }
        .simple-element {
            background: #3498db;
            color: white;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .preview-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .preview-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: white;
        }
        .preview-item img {
            max-width: 300px;
            max-height: 200px;
            border: 1px solid #ccc;
        }
        .stats {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>画像処理機能テスト - AdPreviewCapture</h1>
        
        <div class="test-section">
            <h2>テスト対象要素</h2>
            
            <div class="test-element simple-element" id="simple-element">
                シンプルな広告要素
                <br>単色背景でテキストのみ
            </div>
            
            <div class="test-element complex-element" id="complex-element">
                複雑な広告要素
                <br>パターン背景と複数色
            </div>
            
            <div class="test-element" id="gradient-element" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                グラデーション広告要素
                <br>滑らかな色の変化
            </div>
        </div>

        <div class="test-section">
            <h2>テスト実行</h2>
            <button onclick="testImageProcessing()">画像処理テスト実行</button>
            <button onclick="testMultipleElements()">複数要素テスト</button>
            <button onclick="testCompressionLevels()">圧縮レベルテスト</button>
            <button onclick="clearResults()">結果クリア</button>
        </div>

        <div class="test-section">
            <h2>テスト結果</h2>
            <div id="results" class="results">
                テストを実行してください...
            </div>
        </div>

        <div class="test-section">
            <h2>ログ</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- html2canvas ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- AdPreviewCapture クラス -->
    <script src="content/ad-preview-capture.js"></script>

    <script>
        let adPreviewCapture;
        let testResults = [];

        // 初期化
        async function initializeCapture() {
            if (!adPreviewCapture) {
                adPreviewCapture = new AdPreviewCapture({
                    debugMode: true,
                    imageQuality: 0.8
                });
                await adPreviewCapture.waitForInit();
                log('AdPreviewCapture initialized');
            }
            return adPreviewCapture;
        }

        // ログ出力
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // 結果表示
        function displayResults(results) {
            const resultsElement = document.getElementById('results');
            let html = '';

            results.forEach((result, index) => {
                html += `
                    <div class="preview-container">
                        <h3>要素 ${index + 1}: ${result.elementInfo.tagName}</h3>
                        
                        <div class="preview-item">
                            <h4>サムネイル (${result.screenshot.thumbnailSize.width}x${result.screenshot.thumbnailSize.height})</h4>
                            <img src="${result.screenshot.thumbnail}" alt="Thumbnail">
                            <div class="stats">
                                フォーマット: ${result.screenshot.thumbnailFormat}<br>
                                品質: ${result.screenshot.quality.thumbnail}<br>
                                サイズ: ${result.screenshot.compression.thumbnailPixels} pixels<br>
                                圧縮率: ${result.screenshot.compression.thumbnailReduction}% 削減
                            </div>
                        </div>
                        
                        <div class="preview-item">
                            <h4>拡大表示用 (${result.screenshot.fullSizeSize.width}x${result.screenshot.fullSizeSize.height})</h4>
                            <img src="${result.screenshot.fullSize}" alt="Full Size">
                            <div class="stats">
                                フォーマット: ${result.screenshot.fullSizeFormat}<br>
                                品質: ${result.screenshot.quality.fullSize}<br>
                                サイズ: ${result.screenshot.compression.fullSizePixels} pixels<br>
                                圧縮率: ${result.screenshot.compression.fullSizeReduction}% 削減
                            </div>
                        </div>
                        
                        <div class="stats">
                            処理時間: ${result.screenshot.processingTime}ms<br>
                            元サイズ: ${result.screenshot.original.width}x${result.screenshot.original.height}<br>
                            キャプチャ時間: ${result.captureTime}ms
                        </div>
                    </div>
                `;
            });

            resultsElement.innerHTML = html;
        }

        // 画像処理テスト
        async function testImageProcessing() {
            try {
                log('画像処理テスト開始...');
                const capture = await initializeCapture();
                
                const elements = [
                    document.getElementById('simple-element'),
                    document.getElementById('complex-element'),
                    document.getElementById('gradient-element')
                ];

                const results = [];
                
                for (const element of elements) {
                    log(`要素をキャプチャ中: ${element.id}`);
                    const result = await capture.captureElement(element);
                    results.push(result);
                    
                    log(`キャプチャ完了: ${element.id} (${result.captureTime}ms)`);
                }

                testResults = results;
                displayResults(results);
                log('画像処理テスト完了');

            } catch (error) {
                log(`エラー: ${error.message}`);
                console.error('Test error:', error);
            }
        }

        // 複数要素テスト
        async function testMultipleElements() {
            try {
                log('複数要素テスト開始...');
                const capture = await initializeCapture();
                
                const elements = [
                    document.getElementById('simple-element'),
                    document.getElementById('complex-element'),
                    document.getElementById('gradient-element')
                ];

                const startTime = Date.now();
                const results = await capture.captureMultipleElements(elements);
                const totalTime = Date.now() - startTime;

                testResults = results;
                displayResults(results);
                log(`複数要素テスト完了: ${results.length}個の要素を${totalTime}msで処理`);

            } catch (error) {
                log(`エラー: ${error.message}`);
                console.error('Multiple elements test error:', error);
            }
        }

        // 圧縮レベルテスト
        async function testCompressionLevels() {
            try {
                log('圧縮レベルテスト開始...');
                const capture = await initializeCapture();
                
                const element = document.getElementById('complex-element');
                const qualities = [0.3, 0.5, 0.7, 0.9];
                const results = [];

                for (const quality of qualities) {
                    log(`品質 ${quality} でテスト中...`);
                    const result = await capture.captureElement(element, {
                        thumbnailQuality: quality,
                        fullSizeQuality: quality
                    });
                    results.push({
                        ...result,
                        testQuality: quality
                    });
                }

                // 圧縮比較表示
                let html = '<h3>圧縮レベル比較</h3><div class="preview-container">';
                results.forEach(result => {
                    html += `
                        <div class="preview-item">
                            <h4>品質: ${result.testQuality}</h4>
                            <img src="${result.screenshot.thumbnail}" alt="Quality ${result.testQuality}">
                            <div class="stats">
                                処理時間: ${result.screenshot.processingTime}ms<br>
                                フォーマット: ${result.screenshot.thumbnailFormat}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                document.getElementById('results').innerHTML = html;
                log('圧縮レベルテスト完了');

            } catch (error) {
                log(`エラー: ${error.message}`);
                console.error('Compression test error:', error);
            }
        }

        // 結果クリア
        function clearResults() {
            document.getElementById('results').innerHTML = 'テストを実行してください...';
            document.getElementById('log').innerHTML = '';
            testResults = [];
            log('結果をクリアしました');
        }

        // ページ読み込み時の初期化
        window.addEventListener('load', async () => {
            log('ページ読み込み完了');
            try {
                await initializeCapture();
                log('AdPreviewCapture 準備完了');
            } catch (error) {
                log(`初期化エラー: ${error.message}`);
            }
        });
    </script>
</body>
</html>