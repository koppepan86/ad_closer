<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像処理機能 総合テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-element {
            width: 400px;
            height: 300px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            border-radius: 10px;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .preview {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        .preview img {
            max-width: 100%;
            border: 1px solid #ccc;
            margin: 5px 0;
        }
        .stats {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>画像処理機能 総合テスト</h1>
        
        <div class="test-section">
            <h2>テスト対象要素</h2>
            <div class="test-element" id="test-element">
                テスト用広告要素
            </div>
        </div>

        <div class="test-section">
            <h2>テスト実行</h2>
            <button onclick="runUnitTests()" id="unit-test-btn">ユニットテスト実行</button>
            <button onclick="runIntegrationTest()" id="integration-test-btn">統合テスト実行</button>
            <button onclick="runPerformanceTest()" id="performance-test-btn">パフォーマンステスト実行</button>
            <button onclick="clearResults()">結果クリア</button>
        </div>

        <div class="test-section">
            <h2>テスト結果</h2>
            <div id="test-results" class="results">
                テストを実行してください...
            </div>
        </div>

        <div class="test-section">
            <h2>ログ</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- html2canvas ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- AdPreviewCapture クラス -->
    <script src="content/ad-preview-capture.js"></script>
    
    <!-- テストモジュール -->
    <script src="tests/image-processing.test.js"></script>

    <script>
        let testResults = [];
        let adPreviewCapture;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        async function initializeCapture() {
            if (!adPreviewCapture) {
                adPreviewCapture = new AdPreviewCapture({
                    debugMode: true,
                    imageQuality: 0.8
                });
                await adPreviewCapture.waitForInit();
                log('AdPreviewCapture初期化完了', 'success');
            }
            return adPreviewCapture;
        }

        async function runUnitTests() {
            try {
                log('ユニットテスト開始...', 'info');
                document.getElementById('unit-test-btn').disabled = true;
                
                const success = await runImageProcessingTests();
                
                const resultHtml = generateTestReport(success);
                document.getElementById('test-results').innerHTML = resultHtml;
                
                log(`ユニットテスト${success ? '成功' : '失敗'}`, success ? 'success' : 'error');
                
            } catch (error) {
                log(`ユニットテストエラー: ${error.message}`, 'error');
            } finally {
                document.getElementById('unit-test-btn').disabled = false;
            }
        }

        async function runIntegrationTest() {
            try {
                log('統合テスト開始...', 'info');
                document.getElementById('integration-test-btn').disabled = true;
                
                const capture = await initializeCapture();
                const element = document.getElementById('test-element');
                
                // 統合テスト実行
                const result = await capture.captureElement(element);
                
                // 結果表示
                const resultHtml = `
                    <h3>統合テスト結果</h3>
                    <div class="test-grid">
                        <div class="preview">
                            <h4>サムネイル</h4>
                            <img src="${result.screenshot.thumbnail}" alt="Thumbnail">
                            <div class="stats">
                                サイズ: ${result.screenshot.thumbnailSize.width}x${result.screenshot.thumbnailSize.height}<br>
                                フォーマット: ${result.screenshot.thumbnailFormat}<br>
                                品質: ${result.screenshot.quality.thumbnail}
                            </div>
                        </div>
                        
                        <div class="preview">
                            <h4>拡大表示用</h4>
                            <img src="${result.screenshot.fullSize}" alt="Full Size">
                            <div class="stats">
                                サイズ: ${result.screenshot.fullSizeSize.width}x${result.screenshot.fullSizeSize.height}<br>
                                フォーマット: ${result.screenshot.fullSizeFormat}<br>
                                品質: ${result.screenshot.quality.fullSize}
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats">
                        <strong>パフォーマンス:</strong><br>
                        キャプチャ時間: ${result.captureTime}ms<br>
                        画像処理時間: ${result.screenshot.processingTime}ms<br>
                        <br>
                        <strong>圧縮統計:</strong><br>
                        サムネイル圧縮率: ${result.screenshot.compression.thumbnailReduction}%<br>
                        拡大画像圧縮率: ${result.screenshot.compression.fullSizeReduction}%
                    </div>
                `;
                
                document.getElementById('test-results').innerHTML = resultHtml;
                log('統合テスト完了', 'success');
                
            } catch (error) {
                log(`統合テストエラー: ${error.message}`, 'error');
                document.getElementById('test-results').innerHTML = `
                    <h3>統合テストエラー</h3>
                    <p class="error">${error.message}</p>
                `;
            } finally {
                document.getElementById('integration-test-btn').disabled = false;
            }
        }

        async function runPerformanceTest() {
            try {
                log('パフォーマンステスト開始...', 'info');
                document.getElementById('performance-test-btn').disabled = true;
                
                const capture = await initializeCapture();
                const element = document.getElementById('test-element');
                
                const iterations = 5;
                const times = [];
                
                for (let i = 0; i < iterations; i++) {
                    log(`パフォーマンステスト ${i + 1}/${iterations}`, 'info');
                    
                    const startTime = Date.now();
                    await capture.captureElement(element);
                    const endTime = Date.now();
                    
                    times.push(endTime - startTime);
                }
                
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const minTime = Math.min(...times);
                const maxTime = Math.max(...times);
                
                const resultHtml = `
                    <h3>パフォーマンステスト結果</h3>
                    <div class="stats">
                        <strong>実行回数:</strong> ${iterations}回<br>
                        <strong>平均時間:</strong> ${avgTime.toFixed(1)}ms<br>
                        <strong>最短時間:</strong> ${minTime}ms<br>
                        <strong>最長時間:</strong> ${maxTime}ms<br>
                        <strong>全実行時間:</strong> [${times.join(', ')}]ms
                    </div>
                `;
                
                document.getElementById('test-results').innerHTML = resultHtml;
                log(`パフォーマンステスト完了 - 平均: ${avgTime.toFixed(1)}ms`, 'success');
                
            } catch (error) {
                log(`パフォーマンステストエラー: ${error.message}`, 'error');
            } finally {
                document.getElementById('performance-test-btn').disabled = false;
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = 'テストを実行してください...';
            document.getElementById('log').innerHTML = '';
            log('結果をクリアしました', 'info');
        }

        // ページ読み込み時の初期化
        window.addEventListener('load', async () => {
            log('ページ読み込み完了', 'info');
            try {
                await initializeCapture();
                log('準備完了 - テストを実行できます', 'success');
            } catch (error) {
                log(`初期化エラー: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>