# 通知システムの最適化

## 問題の概要

広告検出時に2つの通知システムが重複していました：
1. **ユーザー選択ダイアログ**：広告検出時にブロックするかどうかをユーザーに選択させる右上のポップアップ
2. **Chrome通知**：ブロック後に「広告をブロックしました」という結果を表示するシステム通知

この重複により、ユーザーに不要で煩わしい通知が表示されていました。

## 実施した最適化

### 1. **Chrome通知システムの削除**

#### 削除された機能:
- `showPopupNotification`関数の削除
- バックグラウンドスクリプトでの通知表示処理の削除
- manifest.jsonから`notifications`権限の削除

#### 修正箇所:
```javascript
// 削除前
if (!preferences.notificationsDisabled) {
  await showPopupNotification(popupData, sender.tab, 'blocked');
}

// 削除後
// Chrome通知は削除（ユーザー選択ダイアログのみ使用）
```

### 2. **ユーザー選択ダイアログの保持**

#### 保持された機能:
- 右上のポップアップ通知（ユーザー選択ダイアログ）
- ブロック/許可の選択機能
- サイト別設定の記憶機能
- 自動タイマー機能

### 3. **バッジ機能の保持**

#### 保持された機能:
- 拡張機能アイコンのバッジ表示
- 日別ブロック数の表示
- バッジ設定のオン/オフ機能

### 4. **ポップアップUIの簡素化**

#### 削除された設定:
- Chrome通知のオン/オフ設定
- 通知内容のカスタマイズ設定

#### 保持された設定:
- バッジ表示のオン/オフ設定

### 5. **テストシステムの更新**

#### 削除されたテスト:
- `testNotificationPermission()` - 通知権限テスト
- `testDirectNotification()` - 直接通知テスト

#### 保持されたテスト:
- `testUserChoiceDialog()` - ユーザー選択ダイアログテスト
- `testBadgeUpdate()` - バッジ更新テスト

## 最適化後のユーザーエクスペリエンス

### 🎯 改善された点

1. **通知の重複解消**
   - 1つの広告検出につき1つの通知のみ表示
   - ユーザーの選択が完了すれば追加の通知なし

2. **シンプルなワークフロー**
   ```
   広告検出 → ユーザー選択ダイアログ → 選択に基づく処理 → 完了
   ```

3. **不要な権限の削除**
   - `notifications`権限が不要になり、セキュリティが向上
   - より軽量な拡張機能

4. **一貫したUI**
   - 全ての通知が右上のポップアップで統一
   - システム通知との混在がなくなり、一貫性が向上

### 📋 現在の通知システム

#### **ユーザー選択ダイアログ**（右上ポップアップ）
- **表示タイミング**: 広告検出時
- **内容**: 「X個の広告を検出しました」
- **選択肢**: ブロック / 許可 / 設定
- **追加機能**: 
  - サイト別設定の記憶
  - 自動ブロック設定
  - 10秒後の自動許可

#### **バッジ通知**（拡張機能アイコン）
- **表示内容**: 日別ブロック数
- **更新タイミング**: 広告ブロック時
- **設定**: オン/オフ切り替え可能

## 技術的詳細

### 削除されたコード

```javascript
// showPopupNotification関数（削除）
async function showPopupNotification(data, tab, action) {
  // Chrome通知の作成と表示処理
  await chrome.notifications.create(notificationId, {
    type: 'basic',
    iconUrl: 'icons/icon48.png',
    title: title,
    message: message,
    priority: action === 'blocked' ? 2 : 1
  });
}
```

### 保持されたコード

```javascript
// ユーザー選択ダイアログ（保持）
async showChoiceDialog(detectedAds) {
  // 右上ポップアップの表示
  const userChoice = await window.userChoiceDialog.showChoiceDialog(detectedPopups);
  // ユーザーの選択に基づく処理
}
```

## パフォーマンスへの影響

### ✅ 改善された点

1. **メモリ使用量の削減**
   - Chrome通知システムの削除により軽量化
   - 不要なイベントリスナーの削除

2. **権限の最小化**
   - `notifications`権限の削除
   - セキュリティリスクの軽減

3. **処理の簡素化**
   - 通知処理のパスが1つに統一
   - デバッグとメンテナンスが容易

## 今後の改善点

### 1. **ユーザー選択ダイアログの機能拡張**
- より詳細な広告情報の表示
- カスタマイズ可能な自動タイマー
- テーマ設定の追加

### 2. **統計機能の強化**
- 週別・月別統計の追加
- サイト別統計の詳細表示
- エクスポート機能

### 3. **設定の柔軟性向上**
- 広告タイプ別の設定
- 時間帯別の自動設定
- より細かい通知制御

## まとめ

通知システムの最適化により：

✅ **重複通知の解消**: 1つの広告検出につき1つの通知のみ
✅ **ユーザビリティの向上**: シンプルで一貫したUI
✅ **パフォーマンスの改善**: 軽量化とセキュリティ向上
✅ **メンテナンス性の向上**: コードの簡素化

これにより、ユーザーにとってより快適で効率的な広告ブロック体験を提供できるようになりました。