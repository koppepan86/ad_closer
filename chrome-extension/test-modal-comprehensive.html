<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal Comprehensive Test - Task 6</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .test-btn {
            padding: 10px 20px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .test-btn:hover {
            background: #007bff;
            color: white;
        }
        
        .test-btn.success {
            border-color: #28a745;
            color: #28a745;
        }
        
        .test-btn.success:hover {
            background: #28a745;
            color: white;
        }
        
        .test-btn.warning {
            border-color: #ffc107;
            color: #856404;
        }
        
        .test-btn.warning:hover {
            background: #ffc107;
            color: #856404;
        }
        
        .mock-ads {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .mock-ad {
            height: 150px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        
        .mock-ad::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.1) 75%);
            background-size: 20px 20px;
        }
        
        .mock-ad.overlay {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .mock-ad.banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .mock-ad.popup {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .mock-ad.video {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        #gallery-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            background: #fafafa;
            margin: 20px 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-item {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
            background: #f8f9fa;
        }
        
        .status-item.pass {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .status-item.fail {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .status-item.pending {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .status-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .status-description {
            font-size: 12px;
            color: #666;
        }
        
        #log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .feature-demo {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .feature-demo h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔍 Task 6 Comprehensive Test - 拡大表示モーダルの実装</h1>
        
        <div class="test-section">
            <div class="test-title">📋 Task 6 Requirements</div>
            <div class="feature-demo">
                <h4>実装要件:</h4>
                <ul>
                    <li>✅ 拡大表示モーダルのHTML/CSS作成</li>
                    <li>✅ プレビュー画像クリック時の拡大表示機能を実装</li>
                    <li>✅ モーダルの開閉アニメーション実装</li>
                    <li>✅ 要素詳細情報の表示機能を実装</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">🎯 Test Scenarios</div>
            <div class="mock-ads">
                <div class="mock-ad overlay" data-ad-type="overlay">
                    オーバーレイ広告<br>
                    <small>スクリーンショット付き</small>
                </div>
                <div class="mock-ad banner" data-ad-type="banner">
                    バナー広告<br>
                    <small>フォールバック表示</small>
                </div>
                <div class="mock-ad popup" data-ad-type="popup">
                    ポップアップ広告<br>
                    <small>詳細情報表示</small>
                </div>
                <div class="mock-ad video" data-ad-type="video">
                    動画広告<br>
                    <small>アニメーションテスト</small>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">🚀 Test Controls</div>
            <div class="test-controls">
                <button class="test-btn" onclick="runFullTest()">🔄 Full Test Suite</button>
                <button class="test-btn" onclick="testModalWithScreenshots()">📸 With Screenshots</button>
                <button class="test-btn" onclick="testModalFallback()">🔄 Fallback Display</button>
                <button class="test-btn" onclick="testAnimations()">✨ Animations</button>
                <button class="test-btn" onclick="testKeyboardNav()">⌨️ Keyboard Nav</button>
                <button class="test-btn" onclick="testAccessibility()">♿ Accessibility</button>
                <button class="test-btn warning" onclick="clearTest()">🗑️ Clear</button>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">📊 Test Status</div>
            <div class="status-grid" id="status-grid">
                <div class="status-item pending" id="status-modal-creation">
                    <div class="status-title">Modal Creation</div>
                    <div class="status-description">HTML/CSS structure creation</div>
                </div>
                <div class="status-item pending" id="status-click-expand">
                    <div class="status-title">Click to Expand</div>
                    <div class="status-description">Preview click functionality</div>
                </div>
                <div class="status-item pending" id="status-animations">
                    <div class="status-title">Animations</div>
                    <div class="status-description">Open/close animations</div>
                </div>
                <div class="status-item pending" id="status-detail-info">
                    <div class="status-title">Detail Information</div>
                    <div class="status-description">Element details display</div>
                </div>
                <div class="status-item pending" id="status-fallback">
                    <div class="status-title">Fallback Display</div>
                    <div class="status-description">No screenshot handling</div>
                </div>
                <div class="status-item pending" id="status-keyboard">
                    <div class="status-title">Keyboard Navigation</div>
                    <div class="status-description">ESC, Tab, focus trap</div>
                </div>
                <div class="status-item pending" id="status-accessibility">
                    <div class="status-title">Accessibility</div>
                    <div class="status-description">ARIA attributes, focus</div>
                </div>
                <div class="status-item pending" id="status-responsive">
                    <div class="status-title">Responsive Design</div>
                    <div class="status-description">Mobile compatibility</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">🖼️ Preview Gallery</div>
            <div id="gallery-container">
                <p style="text-align: center; color: #666; margin: 50px 0;">
                    テストを実行してプレビューギャラリーを表示してください
                </p>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">📝 Test Log</div>
            <div id="log">Task 6 Comprehensive Test Ready...\n</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="content/preview-gallery.js"></script>

    <script>
        let previewGallery = null;
        let testData = [];
        let testResults = {};

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`${prefix} ${message}`);
        }

        function updateStatus(statusId, status, description = '') {
            const element = document.getElementById(statusId);
            if (element) {
                element.classList.remove('pass', 'fail', 'pending');
                element.classList.add(status);
                
                if (description) {
                    const descElement = element.querySelector('.status-description');
                    if (descElement) {
                        descElement.textContent = description;
                    }
                }
                
                testResults[statusId] = { status, description };
            }
        }

        function clearTest() {
            if (previewGallery) {
                previewGallery.cleanup();
                previewGallery = null;
            }
            
            document.getElementById('gallery-container').innerHTML = 
                '<p style="text-align: center; color: #666; margin: 50px 0;">テストがクリアされました</p>';
            document.getElementById('log').textContent = 'Test cleared...\n';
            
            // Reset all status items
            const statusItems = document.querySelectorAll('.status-item');
            statusItems.forEach(item => {
                item.classList.remove('pass', 'fail');
                item.classList.add('pending');
            });
            
            testResults = {};
            testData = [];
            log('All tests cleared', 'warning');
        }

        async function generateTestData(includeScreenshots = true) {
            const mockAds = document.querySelectorAll('.mock-ad');
            const previewData = [];
            
            for (let i = 0; i < mockAds.length; i++) {
                const ad = mockAds[i];
                const rect = ad.getBoundingClientRect();
                const adType = ad.getAttribute('data-ad-type');
                
                const baseData = {
                    id: `test_preview_${i}`,
                    element: ad,
                    elementInfo: {
                        tagName: ad.tagName,
                        className: ad.className,
                        id: ad.id || `ad-${adType}-${i}`,
                        position: { x: Math.round(rect.left), y: Math.round(rect.top) },
                        size: { width: Math.round(rect.width), height: Math.round(rect.height) },
                        zIndex: window.getComputedStyle(ad).zIndex || 'auto',
                        type: adType === 'overlay' ? 'オーバーレイ広告' : 
                              adType === 'banner' ? 'バナー広告' : 
                              adType === 'popup' ? 'ポップアップ広告' : 
                              adType === 'video' ? '動画広告' : '広告要素'
                    },
                    captureTime: Math.random() * 100 + 50,
                    timestamp: Date.now()
                };
                
                if (includeScreenshots && (i === 0 || i === 2)) { // Only first and third have screenshots
                    try {
                        const canvas = await html2canvas(ad, {
                            width: rect.width,
                            height: rect.height,
                            scale: 1
                        });
                        
                        // Create thumbnail
                        const thumbnailCanvas = document.createElement('canvas');
                        const thumbnailCtx = thumbnailCanvas.getContext('2d');
                        thumbnailCanvas.width = 150;
                        thumbnailCanvas.height = 100;
                        thumbnailCtx.drawImage(canvas, 0, 0, 150, 100);
                        
                        // Create full size
                        const fullSizeCanvas = document.createElement('canvas');
                        const fullSizeCtx = fullSizeCanvas.getContext('2d');
                        fullSizeCanvas.width = 600;
                        fullSizeCanvas.height = 400;
                        fullSizeCtx.drawImage(canvas, 0, 0, 600, 400);
                        
                        baseData.screenshot = {
                            thumbnail: thumbnailCanvas.toDataURL('image/png', 0.8),
                            fullSize: fullSizeCanvas.toDataURL('image/png', 0.8),
                            width: canvas.width,
                            height: canvas.height,
                            format: 'png'
                        };
                        
                        log(`Screenshot generated for ${adType}`, 'success');
                        
                    } catch (error) {
                        log(`Screenshot failed for ${adType}: ${error.message}`, 'error');
                        baseData.screenshot = null;
                        baseData.fallback = {
                            reason: 'capture_failed',
                            description: 'スクリーンショットの取得に失敗しました'
                        };
                    }
                } else {
                    // Intentionally no screenshot for fallback testing
                    baseData.screenshot = null;
                    baseData.fallback = {
                        reason: 'no_screenshot',
                        description: 'プレビュー画像は利用できませんが、要素の詳細情報を確認できます。'
                    };
                }
                
                previewData.push(baseData);
            }
            
            return previewData;
        }

        async function runFullTest() {
            try {
                log('🚀 Starting comprehensive modal test suite...', 'info');
                clearTest();
                
                // Generate test data
                testData = await generateTestData(true);
                log(`Generated ${testData.length} test previews`, 'success');
                
                // Create PreviewGallery
                previewGallery = new PreviewGallery({
                    debugMode: true,
                    showElementInfo: true,
                    enableIndividualSelection: true,
                    enableExpandedView: true,
                    animationDuration: 300,
                    onExpandedView: (previewData) => {
                        log(`Modal opened for: ${previewData.elementInfo.type}`, 'success');
                        setTimeout(() => verifyModalFeatures(), 200);
                    }
                });
                
                // Render gallery
                const container = document.getElementById('gallery-container');
                container.innerHTML = '';
                await previewGallery.renderPreviews(testData, container);
                
                updateStatus('status-modal-creation', 'pass', 'Gallery rendered successfully');
                log('Gallery rendered successfully', 'success');
                
                // Test modal opening
                setTimeout(() => {
                    log('Testing modal opening...', 'info');
                    previewGallery.showExpandedView(testData[0].id);
                    updateStatus('status-click-expand', 'pass', 'Modal opens on click');
                }, 1000);
                
            } catch (error) {
                log(`Full test failed: ${error.message}`, 'error');
                updateStatus('status-modal-creation', 'fail', error.message);
            }
        }

        function verifyModalFeatures() {
            const modal = document.querySelector('.preview-expanded-modal');
            if (!modal) {
                updateStatus('status-modal-creation', 'fail', 'Modal not found');
                return;
            }
            
            // Check modal structure
            const header = modal.querySelector('.preview-expanded-header');
            const body = modal.querySelector('.preview-expanded-body');
            const closeBtn = modal.querySelector('.preview-expanded-close');
            const title = modal.querySelector('.preview-expanded-title');
            
            if (header && body && closeBtn && title) {
                updateStatus('status-modal-creation', 'pass', 'Modal structure complete');
                log('✅ Modal structure verified', 'success');
            } else {
                updateStatus('status-modal-creation', 'fail', 'Missing modal elements');
                log('❌ Modal structure incomplete', 'error');
            }
            
            // Check animations
            const hasShowClass = modal.classList.contains('show');
            const content = modal.querySelector('.preview-expanded-content');
            const computedStyle = window.getComputedStyle(content);
            
            if (hasShowClass && computedStyle.transform !== 'none') {
                updateStatus('status-animations', 'pass', 'Animations working');
                log('✅ Animations verified', 'success');
            } else {
                updateStatus('status-animations', 'fail', 'Animations not working');
                log('❌ Animations failed', 'error');
            }
            
            // Check detail information
            const info = modal.querySelector('.preview-expanded-info');
            const infoRows = modal.querySelectorAll('.preview-expanded-info-row');
            
            if (info && infoRows.length > 0) {
                updateStatus('status-detail-info', 'pass', `${infoRows.length} info rows displayed`);
                log(`✅ Detail info verified (${infoRows.length} rows)`, 'success');
            } else {
                updateStatus('status-detail-info', 'fail', 'Detail info missing');
                log('❌ Detail info missing', 'error');
            }
            
            // Check fallback display
            const fallback = modal.querySelector('.preview-expanded-fallback');
            const image = modal.querySelector('.preview-expanded-image');
            
            if (fallback || image) {
                updateStatus('status-fallback', 'pass', fallback ? 'Fallback shown' : 'Image shown');
                log(`✅ Content display verified (${fallback ? 'fallback' : 'image'})`, 'success');
            } else {
                updateStatus('status-fallback', 'fail', 'No content display');
                log('❌ No content display found', 'error');
            }
            
            // Check accessibility
            const hasRole = modal.getAttribute('role') === 'dialog';
            const hasAriaModal = modal.getAttribute('aria-modal') === 'true';
            const hasAriaLabel = modal.getAttribute('aria-labelledby');
            
            if (hasRole && hasAriaModal && hasAriaLabel) {
                updateStatus('status-accessibility', 'pass', 'ARIA attributes present');
                log('✅ Accessibility attributes verified', 'success');
            } else {
                updateStatus('status-accessibility', 'fail', 'Missing ARIA attributes');
                log('❌ Accessibility attributes missing', 'error');
            }
            
            // Test keyboard navigation
            testKeyboardNavigation(modal);
        }

        function testKeyboardNavigation(modal) {
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length > 0) {
                updateStatus('status-keyboard', 'pass', `${focusableElements.length} focusable elements`);
                log(`✅ Keyboard navigation verified (${focusableElements.length} elements)`, 'success');
                
                // Test ESC key
                setTimeout(() => {
                    const escEvent = new KeyboardEvent('keydown', { key: 'Escape' });
                    document.dispatchEvent(escEvent);
                    
                    setTimeout(() => {
                        const modalStillExists = document.querySelector('.preview-expanded-modal');
                        if (!modalStillExists) {
                            log('✅ ESC key closes modal', 'success');
                        } else {
                            log('❌ ESC key failed to close modal', 'error');
                        }
                    }, 400);
                }, 500);
            } else {
                updateStatus('status-keyboard', 'fail', 'No focusable elements');
                log('❌ No focusable elements found', 'error');
            }
        }

        async function testModalWithScreenshots() {
            try {
                log('Testing modal with screenshots...', 'info');
                clearTest();
                
                testData = await generateTestData(true);
                previewGallery = new PreviewGallery({
                    debugMode: true,
                    enableExpandedView: true,
                    onExpandedView: (previewData) => {
                        log(`Modal with screenshot opened: ${previewData.elementInfo.type}`, 'success');
                    }
                });
                
                const container = document.getElementById('gallery-container');
                container.innerHTML = '';
                await previewGallery.renderPreviews(testData, container);
                
                setTimeout(() => {
                    previewGallery.showExpandedView(testData[0].id);
                }, 500);
                
            } catch (error) {
                log(`Screenshot test failed: ${error.message}`, 'error');
            }
        }

        async function testModalFallback() {
            try {
                log('Testing modal fallback display...', 'info');
                clearTest();
                
                testData = await generateTestData(false); // No screenshots
                previewGallery = new PreviewGallery({
                    debugMode: true,
                    enableExpandedView: true,
                    onExpandedView: (previewData) => {
                        log(`Modal with fallback opened: ${previewData.elementInfo.type}`, 'success');
                        setTimeout(() => {
                            const fallback = document.querySelector('.preview-expanded-fallback');
                            if (fallback) {
                                updateStatus('status-fallback', 'pass', 'Fallback display working');
                                log('✅ Fallback display verified', 'success');
                            } else {
                                updateStatus('status-fallback', 'fail', 'Fallback display missing');
                                log('❌ Fallback display missing', 'error');
                            }
                        }, 200);
                    }
                });
                
                const container = document.getElementById('gallery-container');
                container.innerHTML = '';
                await previewGallery.renderPreviews(testData, container);
                
                setTimeout(() => {
                    previewGallery.showExpandedView(testData[1].id);
                }, 500);
                
            } catch (error) {
                log(`Fallback test failed: ${error.message}`, 'error');
            }
        }

        function testAnimations() {
            if (!previewGallery || testData.length === 0) {
                log('Please run a test first', 'warning');
                return;
            }
            
            log('Testing modal animations...', 'info');
            
            // Open modal
            previewGallery.showExpandedView(testData[0].id);
            
            setTimeout(() => {
                const modal = document.querySelector('.preview-expanded-modal');
                if (modal) {
                    const hasShowClass = modal.classList.contains('show');
                    updateStatus('status-animations', hasShowClass ? 'pass' : 'fail', 
                        hasShowClass ? 'Open animation working' : 'Open animation failed');
                    
                    // Test close animation
                    previewGallery.closeExpandedView();
                    
                    setTimeout(() => {
                        const modalAfterClose = document.querySelector('.preview-expanded-modal');
                        const closed = !modalAfterClose;
                        log(`${closed ? '✅' : '❌'} Close animation ${closed ? 'working' : 'failed'}`, 
                            closed ? 'success' : 'error');
                    }, 400);
                }
            }, 200);
        }

        function testKeyboardNav() {
            if (!previewGallery || testData.length === 0) {
                log('Please run a test first', 'warning');
                return;
            }
            
            log('Testing keyboard navigation...', 'info');
            previewGallery.showExpandedView(testData[0].id);
            
            setTimeout(() => {
                const modal = document.querySelector('.preview-expanded-modal');
                if (modal) {
                    testKeyboardNavigation(modal);
                }
            }, 200);
        }

        function testAccessibility() {
            if (!previewGallery || testData.length === 0) {
                log('Please run a test first', 'warning');
                return;
            }
            
            log('Testing accessibility features...', 'info');
            previewGallery.showExpandedView(testData[0].id);
            
            setTimeout(() => {
                const modal = document.querySelector('.preview-expanded-modal');
                if (modal) {
                    const checks = [
                        { name: 'role', check: modal.getAttribute('role') === 'dialog' },
                        { name: 'aria-modal', check: modal.getAttribute('aria-modal') === 'true' },
                        { name: 'aria-labelledby', check: !!modal.getAttribute('aria-labelledby') },
                        { name: 'focus trap', check: document.activeElement && modal.contains(document.activeElement) }
                    ];
                    
                    const passed = checks.filter(c => c.check).length;
                    const total = checks.length;
                    
                    updateStatus('status-accessibility', 
                        passed === total ? 'pass' : 'fail', 
                        `${passed}/${total} accessibility checks passed`);
                    
                    log(`${passed === total ? '✅' : '❌'} Accessibility: ${passed}/${total} checks passed`, 
                        passed === total ? 'success' : 'error');
                    
                    previewGallery.closeExpandedView();
                }
            }, 200);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('🎯 Task 6 Comprehensive Test Suite Ready', 'success');
            log('Click "Full Test Suite" to run all tests', 'info');
        });
    </script>
</body>
</html>