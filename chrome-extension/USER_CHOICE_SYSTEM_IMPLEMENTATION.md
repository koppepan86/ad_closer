# ユーザー選択システムの実装

## 概要

広告検出時にユーザーがブロックするかどうかを選択できるシステムを実装しました。これにより、拡張機能は自動的に広告をブロックするのではなく、ユーザーの判断に基づいて動作します。

## 実装された機能

### 1. **ユーザー選択ダイアログ**

#### 新ファイル: `content/user-choice-dialog.js`
- 広告検出時に表示される選択ダイアログ
- ユーザーフレンドリーなUI
- 自動タイマー機能（15秒後に自動許可）
- 設定記憶機能

#### 主要機能:
- **選択オプション**: ブロック、許可、設定
- **記憶機能**: サイト別の選択を記憶
- **自動ブロック設定**: 今後は自動的にブロック
- **レスポンシブデザイン**: 様々な画面サイズに対応

### 2. **PopupDetector の更新**

#### 修正内容:
- `requestUserChoice()` メソッドを追加
- `blockDetectedAds()` メソッドを追加
- `allowDetectedAds()` メソッドを追加
- `updateSiteSettings()` メソッドを追加
- `getUserPreferences()` メソッドを追加

#### 動作フロー:
```
広告検出 → ユーザー設定確認 → 選択ダイアログ表示 → ユーザー選択 → アクション実行
```

### 3. **バックグラウンドスクリプトの拡張**

#### 新機能:
- `handleUserChoiceRecorded()` - ユーザー選択の記録
- `updateSiteSettings()` - サイト別設定の更新
- `recordAllowedAds()` - 許可された広告の統計記録
- `recordUserDecision()` - ユーザー決定の履歴記録
- `getUserDecisions()` - 決定履歴の取得

#### 新メッセージハンドラー:
- `USER_CHOICE_RECORDED` - ユーザー選択の記録
- `UPDATE_SITE_SETTINGS` - サイト設定の更新
- `OPEN_SETTINGS` - 設定ページを開く

### 4. **統計システムの拡張**

#### 追加された統計:
- **ブロックされた広告**: `totalBlocked`, `dailyStats`
- **許可された広告**: `totalAllowed`, `dailyAllowedStats`
- **ユーザー決定履歴**: 選択内容、応答時間、理由

### 5. **設定システムの拡張**

#### 新設定項目:
- `autoBlockEnabled` - 自動ブロック機能
- `siteSettings` - サイト別設定
- `notificationSettings` - 通知設定の詳細

## 使用方法

### 1. **基本的な使用フロー**

1. **広告検出**: PopupDetectorが広告を検出
2. **ダイアログ表示**: ユーザー選択ダイアログが表示
3. **ユーザー選択**: 
   - 「ブロックする」: 広告を非表示にする
   - 「許可する」: 広告をそのまま表示
   - 「設定」: 拡張機能の設定を開く
4. **アクション実行**: 選択に基づいて処理を実行
5. **統計更新**: 選択内容を統計に記録

### 2. **自動化オプション**

#### サイト別設定:
- 「このサイトでの選択を記憶する」をチェック
- 次回から同じサイトでは自動的に同じアクションを実行

#### 全体設定:
- 「今後は自動的にブロックする」をチェック
- 全てのサイトで自動的にブロック

### 3. **設定の優先順位**

1. **自動ブロック設定** (最高優先度)
2. **サイト別設定**
3. **ユーザー選択ダイアログ** (デフォルト)

## テスト方法

### 1. **テストページの使用**

```
chrome-extension/test-notification-system.html
```

#### テスト項目:
- ユーザー選択ダイアログテスト
- 広告検出とダイアログ表示
- 選択結果の記録
- 統計更新の確認

### 2. **手動テスト**

1. **テスト広告を作成**: 「テスト広告を作成」ボタン
2. **検出をトリガー**: 「検出をトリガー」ボタン
3. **ダイアログで選択**: ブロック/許可を選択
4. **結果確認**: 広告の表示状態と統計を確認

### 3. **自動テスト**

```javascript
// ユーザー選択ダイアログのテスト
function testUserChoiceDialog() {
    const testAds = [
        { type: 'overlay', element: { tagName: 'DIV', id: 'test-ad-1' } }
    ];
    
    window.userChoiceDialog.showChoiceDialog(testAds).then((result) => {
        console.log('User choice:', result);
    });
}
```

## データ構造

### 1. **ユーザー選択結果**

```javascript
{
    action: 'block' | 'allow' | 'settings',
    detectedAds: [...],
    options: {
        rememberChoice: boolean,
        autoBlock: boolean
    },
    timestamp: number,
    responseTime: number
}
```

### 2. **サイト設定**

```javascript
{
    siteSettings: {
        'example.com': {
            autoAction: 'block' | 'allow',
            options: {...},
            timestamp: number
        }
    }
}
```

### 3. **統計データ**

```javascript
{
    statistics: {
        totalBlocked: number,
        totalAllowed: number,
        dailyStats: { '2024-01-01': number },
        dailyAllowedStats: { '2024-01-01': number }
    }
}
```

## 技術的詳細

### 1. **ダイアログのスタイリング**

- **モダンなデザイン**: Material Design風のUI
- **アニメーション**: スムーズな表示アニメーション
- **レスポンシブ**: 様々な画面サイズに対応
- **アクセシビリティ**: キーボード操作対応

### 2. **パフォーマンス最適化**

- **非同期処理**: ダイアログ表示中もページ操作可能
- **メモリ管理**: 使用後のダイアログは自動削除
- **イベント管理**: 適切なイベントリスナーの追加/削除

### 3. **エラーハンドリング**

- **フォールバック**: エラー時は自動的に許可
- **ログ記録**: 詳細なエラーログ
- **復旧機能**: 失敗時の自動復旧

## セキュリティ考慮事項

### 1. **XSS対策**

- **サニタイゼーション**: ユーザー入力の適切な処理
- **CSP準拠**: Content Security Policy に準拠

### 2. **プライバシー**

- **ローカル保存**: 選択履歴はローカルに保存
- **最小限のデータ**: 必要最小限の情報のみ記録

## 今後の改善点

### 1. **UI/UX改善**

- **カスタマイズ可能なテーマ**
- **より詳細な広告情報表示**
- **ショートカットキー対応**

### 2. **機能拡張**

- **ホワイトリスト/ブラックリスト管理**
- **時間帯別設定**
- **広告タイプ別設定**

### 3. **統計・分析**

- **詳細な使用統計**
- **トレンド分析**
- **パフォーマンス指標**

## まとめ

ユーザー選択システムの実装により、拡張機能は以下の特徴を持つようになりました：

✅ **ユーザー中心**: ユーザーが広告の処理方法を決定
✅ **柔軟性**: サイト別・全体設定の両方に対応
✅ **使いやすさ**: 直感的なダイアログUI
✅ **自動化**: 繰り返し作業の自動化オプション
✅ **統計追跡**: 詳細な使用統計の記録
✅ **拡張性**: 将来の機能追加に対応した設計

これにより、「広告検出時に通知、かつブロックするかどうかの選択をユーザに任せる」という要件が完全に実装されました。