<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一括操作機能テスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button.danger {
            background: #dc3545;
        }
        
        .test-button.danger:hover {
            background: #c82333;
        }
        
        .test-button.success {
            background: #28a745;
        }
        
        .test-button.success:hover {
            background: #218838;
        }
        
        .mock-ad {
            width: 300px;
            height: 200px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            border: 2px solid #ff5252;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 10px;
            position: relative;
        }
        
        .mock-ad::after {
            content: '広告';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .ads-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>一括操作機能テスト</h1>
        <p>広告プレビューシステムの一括操作機能（すべて許可・すべてブロック）をテストします。</p>
        
        <div class="test-section">
            <h2>1. モック広告要素の作成</h2>
            <p>テスト用の広告要素を作成します。</p>
            <button class="test-button" onclick="createMockAds()">モック広告を作成</button>
            <button class="test-button danger" onclick="clearMockAds()">広告をクリア</button>
            
            <div class="ads-container" id="ads-container">
                <!-- モック広告がここに追加されます -->
            </div>
            
            <div id="mock-status" class="status info" style="display: none;">
                モック広告が作成されました
            </div>
        </div>
        
        <div class="test-section">
            <h2>2. 広告検出とダイアログ表示</h2>
            <p>作成された広告を検出してユーザー選択ダイアログを表示します。</p>
            <button class="test-button" onclick="showUserChoiceDialog()" id="show-dialog-btn" disabled>
                ダイアログを表示
            </button>
            
            <div id="dialog-status" class="status info" style="display: none;">
                ダイアログが表示されました。一括操作ボタンをテストしてください。
            </div>
        </div>
        
        <div class="test-section">
            <h2>3. 一括操作テスト手順</h2>
            <ol>
                <li>上記の「モック広告を作成」ボタンをクリック</li>
                <li>「ダイアログを表示」ボタンをクリック</li>
                <li>表示されたダイアログで以下をテスト：
                    <ul>
                        <li>「すべて許可」ボタンをクリック → 確認ダイアログが表示される</li>
                        <li>確認ダイアログで「許可を実行」をクリック → 全広告が許可状態になる</li>
                        <li>「すべてブロック」ボタンをクリック → 確認ダイアログが表示される</li>
                        <li>確認ダイアログで「ブロックを実行」をクリック → 全広告がブロック状態になる</li>
                        <li>結果表示が正しく表示される</li>
                    </ul>
                </li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>4. テスト結果ログ</h2>
            <button class="test-button" onclick="clearLog()">ログをクリア</button>
            <div id="test-log" class="log">
                テストログがここに表示されます...
            </div>
        </div>
    </div>

    <!-- 必要なスクリプトを読み込み -->
    <script src="content/ad-preview-capture.js"></script>
    <script src="content/preview-gallery.js"></script>
    <script src="content/user-choice-dialog.js"></script>

    <script>
        let mockAds = [];
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logElement = document.getElementById('test-log');
            logElement.innerHTML = testLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[BulkOperationsTest] ${message}`);
        }

        function clearLog() {
            testLog = [];
            document.getElementById('test-log').innerHTML = 'テストログがクリアされました...';
        }

        function createMockAds() {
            clearMockAds();
            
            const container = document.getElementById('ads-container');
            const adTypes = [
                { type: 'オーバーレイ広告', content: 'オーバーレイ広告\n320x240px' },
                { type: 'バナー広告', content: 'バナー広告\n728x90px' },
                { type: 'サイドバー広告', content: 'サイドバー広告\n300x600px' },
                { type: 'ポップアップ広告', content: 'ポップアップ広告\n400x300px' },
                { type: '動画広告', content: '動画広告\n640x360px' }
            ];

            adTypes.forEach((adType, index) => {
                const mockAd = document.createElement('div');
                mockAd.className = 'mock-ad';
                mockAd.id = `mock-ad-${index}`;
                mockAd.innerHTML = adType.content;
                mockAd.setAttribute('data-ad-type', adType.type);
                
                container.appendChild(mockAd);
                mockAds.push({
                    element: mockAd,
                    type: adType.type,
                    id: `mock-ad-${index}`,
                    size: { width: 300, height: 200 },
                    position: { x: index * 320, y: 100 }
                });
            });

            document.getElementById('mock-status').style.display = 'block';
            document.getElementById('show-dialog-btn').disabled = false;
            
            log(`${mockAds.length}個のモック広告を作成しました`);
        }

        function clearMockAds() {
            const container = document.getElementById('ads-container');
            container.innerHTML = '';
            mockAds = [];
            
            document.getElementById('mock-status').style.display = 'none';
            document.getElementById('show-dialog-btn').disabled = true;
            
            log('モック広告をクリアしました');
        }

        async function showUserChoiceDialog() {
            if (mockAds.length === 0) {
                log('エラー: モック広告が作成されていません', 'error');
                return;
            }

            try {
                log('ユーザー選択ダイアログを表示中...');
                
                // UserChoiceDialogのインスタンスを取得
                const userChoiceDialog = window.userChoiceDialog;
                if (!userChoiceDialog) {
                    throw new Error('UserChoiceDialog が初期化されていません');
                }

                // ダイアログを表示
                const result = await userChoiceDialog.showChoiceDialog(mockAds);
                
                log(`ダイアログ結果: ${JSON.stringify(result, null, 2)}`);
                document.getElementById('dialog-status').style.display = 'block';
                
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
                console.error('Dialog error:', error);
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            log('一括操作機能テストページが読み込まれました');
            
            // UserChoiceDialogの初期化を確認
            setTimeout(() => {
                if (window.userChoiceDialog) {
                    log('UserChoiceDialog が正常に初期化されました');
                } else {
                    log('警告: UserChoiceDialog の初期化に失敗しました', 'error');
                }
            }, 1000);
        });

        // 一括操作のイベントリスナー（デバッグ用）
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('ad-choice-bulk-button')) {
                const action = e.target.dataset.bulkAction;
                log(`一括操作ボタンがクリックされました: ${action}`);
            }
            
            if (e.target.classList.contains('bulk-confirmation-btn')) {
                const isConfirm = e.target.classList.contains('confirm');
                log(`確認ダイアログボタンがクリックされました: ${isConfirm ? '実行' : 'キャンセル'}`);
            }
        });

        // 結果表示の監視
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        if (node.classList && node.classList.contains('bulk-action-result')) {
                            log('一括操作の結果が表示されました');
                        }
                        if (node.classList && node.classList.contains('bulk-action-confirmation')) {
                            log('一括操作の確認ダイアログが表示されました');
                        }
                    }
                });
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>