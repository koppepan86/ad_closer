# 実装計画

- [x] 1. 既存ハンドラーのActiveTab権限ロジック修正
  - permission-error-handler.jsを修正してactiveTabがユーザーインタラクションを必要とすることを理解させる
  - activeTabを必須権限リストから削除（条件付きであり、常に利用可能ではない）
  - ユーザーインタラクション要件を考慮した適切なactiveTab権限チェックを追加
  - checkPermissionメソッドを更新してactiveTabの特別な動作を処理
  - _要件: 1.1, 1.2, 4.1_

- [x] 2. ユーザーアクション検出システムの実装
  - 拡張機能とのユーザーインタラクション（ポップアップクリック、コンテキストメニューなど）を検出するシステムを作成
  - chrome.action.onClickedおよびその他のユーザーインタラクションイベントのイベントリスナーを追加
  - 確認されたユーザーアクション後にのみ権限要求をトリガーする実装
  - activeTab権限使用を可能にするユーザーインタラクション状態を保存
  - _要件: 1.2, 4.1, 4.2_

- [x] 3. ActiveTab処理のためのバックグラウンドサービスワーカー更新
  - service-worker.jsを修正してactiveTab権限ライフサイクルを適切に処理
  - activeTab権限付与をトリガーするchrome.action.onClickedリスナーを追加
  - activeTabが利用可能になったときにコンテンツスクリプトに通知するメッセージパッシングを実装
  - 拡張機能コンポーネント間でのactiveTab権限状態管理を作成
  - _要件: 1.1, 1.2, 2.4_

- [x] 4. コンテンツスクリプト権限チェック修正
  - content-script.jsを更新してactiveTab権限が常に利用可能であると仮定しないようにする
  - ユーザーインタラクションを待つ権限要求フローを実装
  - activeTab権限が付与されていない場合のフォールバックメソッドを追加
  - activeTab有効化を要求するためのバックグラウンドスクリプトとの通信を作成
  - _要件: 1.3, 2.3, 4.2_

- [ ] 5. 即座の権限検証修正の実装


  - 正確な権限失敗ポイントを特定するクイック診断ツールを作成
  - 拡張機能動作中のリアルタイム権限状態ログを追加
  - ユーザーインタラクション後の権限再試行メカニズムを実装
  - 異なる権限失敗シナリオに対する明確なエラーメッセージを作成
  - _要件: 3.1, 3.2, 3.4_

- [ ] 6. 拡張機能アクションボタン統合の追加
  - 拡張機能ポップアップ/アクションボタンがactiveTab権限を適切にトリガーすることを確保
  - activeTab権限が付与/拒否されたときの視覚的フィードバックを追加
  - 拡張機能アクションインターフェースを通じた権限要求フローを実装
  - 拡張機能ボタンを通じて権限を有効化するためのユーザーガイダンスを作成
  - _要件: 5.1, 5.2, 4.4_

- [ ] 7. 権限修正のテストと検証
  - activeTab権限シナリオの特定のテストケースを作成
  - 異なるユーザーインタラクションパターンでの権限動作をテスト
  - "Required permission missing: activeTab"エラーが解決されることを検証
  - 権限修正後に拡張機能が正しく動作することを確保
  - _要件: 3.1, 3.3, 1.4_

- [ ] 8. ActiveTab失敗時の優雅な劣化の実装
  - activeTabが利用できない場合のコア機能の代替メソッドを作成
  - タブアクセスのためのコンテンツスクリプトベースの代替手段を実装
  - 権限要件と代替手段を説明するユーザー通知を追加
  - activeTab権限なしでも拡張機能が機能し続けることを確保
  - _要件: 1.3, 2.3, 5.3, 5.4_